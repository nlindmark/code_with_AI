{% extends "base.html" %}

{% block title %}Admin - Code with AI{% endblock %}

{% block extra_css %}
<style>
    .admin-panel {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .status-card {
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .status-active {
        border-color: #28a745;
        background-color: #d4edda;
    }
    
    .status-inactive {
        border-color: #dc3545;
        background-color: #f8d7da;
    }
    
    .status-indicator {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .status-active .status-indicator {
        color: #28a745;
    }
    
    .status-inactive .status-indicator {
        color: #dc3545;
    }
    
    .control-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
    }
    
    .stats {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-top: 20px;
    }
    
    .stats h3 {
        margin-bottom: 15px;
        color: #333;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .stat-item {
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    
    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
    }
    
    .stat-label {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-panel">
    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">üéÆ {{ t('admin', 'title') }}</h2>
    
    <div class="status-card {% if state.is_active %}status-active{% else %}status-inactive{% endif %}">
        <div class="status-indicator">
            {% if state.is_active %}
                ‚úÖ {{ t('admin', 'competition_active') }}
            {% else %}
                ‚ùå {{ t('admin', 'competition_inactive') }}
            {% endif %}
        </div>
        <p>
            {% if state.is_active %}
                {{ t('admin', 'started_at', state.start_time_formatted) }}
            {% else %}
                {{ t('admin', 'not_started') }}
            {% endif %}
        </p>
        {% if state.active_competition_id %}
        <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
            {{ t('admin', 'active_competition') }} <strong>
                {% for comp in competitions %}
                    {% if comp.id == state.active_competition_id %}
                        {{ comp.name }}
                    {% endif %}
                {% endfor %}
            </strong>
        </p>
        {% endif %}
    </div>
    
    <div style="background: white; border: 2px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
        <h3 style="margin-bottom: 15px; color: #333; text-align: center;">{{ t('admin', 'select_active_competition') }}</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            {% for comp in competitions %}
            <button onclick="setActiveCompetition('{{ comp.id }}')" 
                    class="btn {% if comp.is_active %}btn-primary{% else %}btn-secondary{% endif %}"
                    style="width: 100%; text-align: left; justify-content: space-between; display: flex;">
                <span>
                    {% if comp.is_active %}‚úÖ {% endif %}
                    <strong>{{ comp.name }}</strong>
                    {% if comp.description %}
                    <br><small style="font-weight: normal; opacity: 0.8;">{{ comp.description }}</small>
                    {% endif %}
                </span>
            </button>
            {% endfor %}
        </div>
    </div>
    
    <div class="control-buttons">
        {% if not state.is_active %}
        <button onclick="startCompetition()" class="btn">
            {{ t('admin', 'start_competition') }}
        </button>
        {% else %}
        <button onclick="stopCompetition()" class="btn btn-danger">
            {{ t('admin', 'stop_competition') }}
        </button>
        {% endif %}
        
        <button onclick="resetData()" class="btn btn-secondary">
            {{ t('admin', 'clear_all_data') }}
        </button>
    </div>
    
    <div class="stats">
        <h3>{{ t('admin', 'statistics') }}</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="total-users">-</div>
                <div class="stat-label">{{ t('admin', 'users') }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-submissions">-</div>
                <div class="stat-label">{{ t('admin', 'submissions') }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completed-levels">-</div>
                <div class="stat-label">{{ t('admin', 'completed_levels') }}</div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 30px; text-align: center;">
        <a href="{{ url_for('leaderboard') }}" class="btn btn-secondary">
            {{ t('admin', 'view_leaderboard') }}
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_KEY = '{{ request.headers.get("X-API-Key", "") }}';
    const translations = {{ translations|tojson }};
    
    function t(category, key, ...args) {
        let text = translations[category] && translations[category][key] ? translations[category][key] : key;
        if (args.length > 0) {
            try {
                return text.replace(/\{\}/g, () => args.shift() || '');
            } catch (e) {
                return text;
            }
        }
        return text;
    }
    
    function startCompetition() {
        fetch('/admin/start', {
            method: 'POST',
            headers: {
                'X-API-Key': API_KEY,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(t('admin', 'alert_started'));
                location.reload();
            } else {
                alert(t('admin', 'error_fetch', data.error));
            }
        })
        .catch(error => {
            alert(t('admin', 'error_start', error));
        });
    }
    
    function stopCompetition() {
        if (confirm(t('admin', 'confirm_stop'))) {
            fetch('/admin/stop', {
                method: 'POST',
                headers: {
                    'X-API-Key': API_KEY,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(t('admin', 'alert_stopped'));
                    location.reload();
                } else {
                    alert(t('admin', 'error_fetch', data.error));
                }
            })
            .catch(error => {
                alert(t('admin', 'error_stop', error));
            });
        }
    }
    
    function setActiveCompetition(competitionId) {
        if (confirm(t('admin', 'confirm_change'))) {
            fetch('/admin/competitions', {
                method: 'POST',
                headers: {
                    'X-API-Key': API_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ competition_id: competitionId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(t('admin', 'alert_changed'));
                    location.reload();
                } else {
                    alert(t('admin', 'error_fetch', data.error));
                }
            })
            .catch(error => {
                alert(t('admin', 'error_change', error));
            });
        }
    }
    
    function resetData() {
        if (confirm(t('admin', 'confirm_reset'))) {
            fetch('/reset', {
                method: 'GET',
                headers: {
                    'X-API-Key': API_KEY
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(t('admin', 'alert_reset'));
                    location.reload();
                } else {
                    alert(t('admin', 'error_fetch', data.error));
                }
            })
            .catch(error => {
                alert(t('admin', 'error_reset', error));
            });
        }
    }
    
    // Ladda statistik
    function loadStats() {
        fetch('/api/leaderboard')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-users').textContent = data.length;
                
                let totalSubmissions = 0;
                let completedLevels = 0;
                
                data.forEach(user => {
                    totalSubmissions += Object.keys(user.levels).length;
                    completedLevels += user.max_level;
                });
                
                document.getElementById('total-submissions').textContent = totalSubmissions;
                document.getElementById('completed-levels').textContent = completedLevels;
            })
            .catch(error => {
                console.error('Error loading statistics:', error);
            });
    }
    
    // Ladda statistik vid sidladdning
    loadStats();
    setInterval(loadStats, 10000); // Uppdatera var 10:e sekund
</script>
{% endblock %}
